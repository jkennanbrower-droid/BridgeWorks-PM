// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Add your models here.
enum AuthProvider {
  CLERK
}

enum PlatformRole {
  founder
  platform_admin
  support_admin
  support_agent
  auditor
}

enum PersonStatus {
  active
  disabled
}

enum OrgStatus {
  active
  suspended
  deleted
}

enum OrgRole {
  org_admin
  staff_manager
  staff_agent
  tenant_user
}

enum MembershipStatus {
  active
  invited
  disabled
}

enum InviteStatus {
  pending_send
  sent
  accepted
  send_failed
  revoked
  expired
}

enum ApplicationStatus {
  draft
  submitted
  provisioning
  provisioned
  rejected
  provisioning_failed
}

enum HealthStatus {
  healthy
  degraded
  down
}

enum MessagingChannel {
  portal
  sms
  email
}

enum MessagingThreadStatus {
  open
  pending
  resolved
  closed
}

enum MessagingThreadPriority {
  low
  normal
  high
  urgent
}

enum MessagingThreadKind {
  direct
  group
}

enum MessagingDeliveryStatus {
  draft
  queued
  sent
  delivered
  read
  failed
}

enum MessagingNotifyPreference {
  immediate
  digest
  muted
}

model Test {
  id        Int      @id @default(autoincrement()) @map("Test #")
  createdAt DateTime @default(now()) @map("Created at") @db.Timestamptz(6)
  createdBy String   @map("Created By")

  @@map("test")
}

model OnboardingApplication {
  id               String            @id @default(uuid()) @db.Uuid
  orgName          String            @map("org_name")
  contactName      String?           @map("contact_name")
  contactEmail     String            @map("contact_email")
  contactPhone     String?           @map("contact_phone")
  portfolioTypes   Json?             @map("portfolio_types") @db.JsonB
  approxProperties Int?              @map("approx_properties")
  approxUnits      Int?              @map("approx_units")
  currentSoftware  String?           @map("current_software")
  notes            String?           @map("notes")
  internalNotes    String?           @map("internal_notes")
  status           ApplicationStatus @default(submitted)
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  submittedAt      DateTime?         @map("submitted_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  provisionedOrgId String?           @map("provisioned_org_id") @db.Uuid
  provisionedAt    DateTime?         @map("provisioned_at") @db.Timestamptz(6)
  lastError        String?           @map("last_error")

  @@map("onboarding_applications")
}

model Person {
  id           String        @id @default(uuid()) @db.Uuid
  clerkUserId  String?       @unique @map("clerk_user_id")
  email        String        @unique
  name         String?
  platformRole PlatformRole? @map("platform_role")
  status       PersonStatus  @default(active)
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLoginAt  DateTime?     @map("last_login_at") @db.Timestamptz(6)

  auditLogs AuditLog[]
  memberships OrgMembership[]

  @@map("people")
}

model Organization {
  id                      String       @id @default(uuid()) @db.Uuid
  name                    String
  slug                    String
  status                  OrgStatus    @default(active)
  primaryContactEmail     String?      @map("primary_contact_email")
  healthStatus            HealthStatus? @map("health_status")
  createdAt               DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt               DateTime?    @map("deleted_at") @db.Timestamptz(6)
  onboardingApplicationId String?      @unique @map("onboarding_application_id") @db.Uuid

  invites Invite[]
  memberships OrgMembership[]
  messagingThreads MessagingThread[]
  messagingThreadParticipants MessagingThreadParticipant[]
  messagingMessages MessagingMessage[]
  messagingAttachments MessagingAttachment[]
  messagingThreadAuditEvents MessagingThreadAuditEvent[]
  messagingThreadFollowers MessagingThreadFollower[]

  @@map("organizations")
}

model OrgMembership {
  id        String           @id @default(uuid()) @db.Uuid
  orgId     String           @map("org_id") @db.Uuid
  personId  String           @map("person_id") @db.Uuid
  orgRole   OrgRole          @map("org_role")
  status    MembershipStatus @default(active)
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [orgId], references: [id])
  person       Person       @relation(fields: [personId], references: [id])

  @@unique([orgId, personId, orgRole])
  @@index([orgId, status])
  @@index([personId, status])
  @@map("org_memberships")
}

model Invite {
  id                String       @id @default(uuid()) @db.Uuid
  orgId             String       @map("org_id") @db.Uuid
  email             String
  role              OrgRole
  clerkInvitationId String?      @map("clerk_invitation_id")
  status            InviteStatus @default(pending_send)
  lastError         String?      @map("last_error")
  sentAt            DateTime?    @map("sent_at") @db.Timestamptz(6)
  revokedAt         DateTime?    @map("revoked_at") @db.Timestamptz(6)
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, email, role])
  @@map("invites")
}

model AuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  actorPersonId String   @map("actor_person_id") @db.Uuid
  orgId         String?  @map("org_id") @db.Uuid
  action        String
  targetType    String   @map("target_type")
  targetId      String   @map("target_id")
  payload       Json?    @map("diff_jsonb") @db.JsonB
  ip            String?  @map("ip")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  actor Person @relation(fields: [actorPersonId], references: [id])

  @@map("audit_log")
}

model MessagingThread {
  id               String                  @id @default(uuid()) @db.Uuid
  orgId            String                  @map("org_id") @db.Uuid
  kind             MessagingThreadKind
  title            String                  @db.Text
  status           MessagingThreadStatus
  priority         MessagingThreadPriority
  channelDefault   MessagingChannel        @map("channel_default")
  propertyId       String?                 @map("property_id") @db.Text
  unitId           String?                 @map("unit_id") @db.Text
  assigneeId       String?                 @map("assignee_id") @db.Text
  assigneeLabel    String?                 @map("assignee_label") @db.Text
  tags             String[]                @default([]) @map("tags")
  dueDate          DateTime?               @map("due_date") @db.Timestamptz(6)
  slaDueAt         DateTime?               @map("sla_due_at") @db.Timestamptz(6)
  linkedWorkOrderId String?                @map("linked_work_order_id") @db.Text
  linkedTaskId     String?                 @map("linked_task_id") @db.Text
  lastMessagePreview String?               @map("last_message_preview") @db.Text
  createdAt        DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime                @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime?               @map("deleted_at") @db.Timestamptz(6)

  organization Organization                @relation(fields: [orgId], references: [id])
  participants MessagingThreadParticipant[]
  messages     MessagingMessage[]
  attachments  MessagingAttachment[]
  auditEvents  MessagingThreadAuditEvent[]
  followers    MessagingThreadFollower[]

  @@index([orgId, updatedAt])
  @@index([orgId, status])
  @@index([orgId, priority])
  @@index([orgId, slaDueAt])
  @@map("messaging_threads")
}

model MessagingThreadParticipant {
  id               String                  @id @default(uuid()) @db.Uuid
  threadId         String                  @map("thread_id") @db.Uuid
  orgId            String                  @map("org_id") @db.Uuid
  participantId    String                  @map("participant_id") @db.Text
  role             String                  @db.Text
  displayName      String                  @map("display_name") @db.Text
  avatarUrl        String?                 @map("avatar_url") @db.Text
  lastReadAt       DateTime?               @map("last_read_at") @db.Timestamptz(6)
  flagged          Boolean                 @default(false) @map("flagged")
  notifyPreference MessagingNotifyPreference @default(immediate) @map("notify_preference")
  createdAt        DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime                @updatedAt @map("updated_at") @db.Timestamptz(6)

  organization Organization                @relation(fields: [orgId], references: [id])
  thread       MessagingThread             @relation(fields: [threadId], references: [id])

  @@unique([threadId, participantId])
  @@index([orgId, participantId])
  @@index([threadId])
  @@map("messaging_thread_participants")
}

model MessagingMessage {
  id               String                @id @default(uuid()) @db.Uuid
  orgId            String                @map("org_id") @db.Uuid
  threadId         String                @map("thread_id") @db.Uuid
  senderId         String                @map("sender_id") @db.Text
  senderLabel      String                @map("sender_label") @db.Text
  body             String                @db.Text
  channel          MessagingChannel
  internalOnly     Boolean               @default(false) @map("internal_only")
  scheduledFor     DateTime?             @map("scheduled_for") @db.Timestamptz(6)
  deliveryStatus   MessagingDeliveryStatus @default(sent) @map("delivery_status")
  deliveryUpdatedAt DateTime?            @map("delivery_updated_at") @db.Timestamptz(6)
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization             @relation(fields: [orgId], references: [id])
  thread       MessagingThread          @relation(fields: [threadId], references: [id])
  attachments  MessagingAttachment[]

  @@index([threadId, createdAt])
  @@index([orgId, createdAt])
  @@index([deliveryStatus])
  @@map("messaging_messages")
}

model MessagingAttachment {
  id          String   @id @default(uuid()) @db.Uuid
  orgId       String   @map("org_id") @db.Uuid
  threadId    String   @map("thread_id") @db.Uuid
  messageId   String?  @map("message_id") @db.Uuid
  fileName    String   @map("file_name") @db.Text
  mimeType    String   @map("mime_type") @db.Text
  sizeBytes   BigInt   @map("size_bytes") @db.BigInt
  uploadedById String  @map("uploaded_by_id") @db.Text
  uploadedAt  DateTime @map("uploaded_at") @db.Timestamptz(6)
  storageKey  String?  @map("storage_key") @db.Text
  publicUrl   String?  @map("public_url") @db.Text
  scanStatus  String?  @map("scan_status") @db.Text

  organization Organization  @relation(fields: [orgId], references: [id])
  thread       MessagingThread @relation(fields: [threadId], references: [id])
  message      MessagingMessage? @relation(fields: [messageId], references: [id])

  @@index([threadId, uploadedAt])
  @@index([messageId])
  @@map("messaging_attachments")
}

model MessagingThreadAuditEvent {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @map("org_id") @db.Uuid
  threadId   String   @map("thread_id") @db.Uuid
  type       String   @db.Text
  actorId    String   @map("actor_id") @db.Text
  actorLabel String   @map("actor_label") @db.Text
  meta       Json?    @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  organization Organization   @relation(fields: [orgId], references: [id])
  thread       MessagingThread @relation(fields: [threadId], references: [id])

  @@index([threadId, createdAt])
  @@index([orgId, createdAt])
  @@map("messaging_thread_audit")
}

model MessagingThreadFollower {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @map("org_id") @db.Uuid
  threadId   String   @map("thread_id") @db.Uuid
  followerId String   @map("follower_id") @db.Text

  organization Organization  @relation(fields: [orgId], references: [id])
  thread       MessagingThread @relation(fields: [threadId], references: [id])

  @@unique([threadId, followerId])
  @@index([followerId])
  @@map("messaging_thread_followers")
}
